# 🔍 スラッシュコマンド同期失敗の診断手順

## 現在の状況

ログから以下のことが分かります：

- ✅ Botは正常にログインしている（Application ID: `1442793864216969268`）
- ✅ ローカルには9個のコマンドが存在
- ✅ `tree.sync()`は成功しているように見える
- ❌ Discord APIから取得したコマンド数が0個

これは、**Botがサーバーに追加されていないか、`applications.commands`スコープが付与されていない**可能性が高いです。

---

## 🔍 診断手順

### ステップ1: Botがサーバーに追加されているか確認

1. **Discordで「Winglish」サーバーを開く**
2. **サーバー名を右クリック** → **「サーバー設定」**
3. **左サイドバーから「メンバー」を選択**
4. **「Winglish Bot」または「Winglish#9545」を探す**

#### 結果

- ✅ **Botがメンバーとして表示されている場合**: ステップ2へ
- ❌ **Botが表示されていない場合**: Botをサーバーに追加してください（ステップ6参照）

---

### ステップ2: Botの権限を確認

1. **Discordで「Winglish」サーバーを開く**
2. **サーバー名を右クリック** → **「サーバー設定」**
3. **左サイドバーから「連携サービス」**（または「統合」）を選択
4. **「Winglish Bot」を探してクリック**
5. **「スラッシュコマンド」の権限があるか確認**

#### 結果

- ✅ **「スラッシュコマンド」の権限がある場合**: ステップ3へ
- ❌ **「スラッシュコマンド」の権限がない場合**: Botを再追加してください（ステップ6参照）

---

### ステップ3: OAuth2 URLを確認

1. **Discord Developer Portal**を開く: https://discord.com/developers/applications
2. **Botアプリケーション**（Application ID: `1442793864216969268`）を選択
3. **左サイドバーから「OAuth2」** → **「URL Generator」**を選択

#### 確認事項

**「SCOPES」セクション**で、以下が**両方とも**チェックされているか確認：

- ✅ **`bot`** - チェックされているか？
- ✅ **`applications.commands`** ← **これが重要！チェックされているか？**

#### URLを確認

生成されたURLをコピーして、以下のように`scope`パラメータを確認してください：

```
https://discord.com/api/oauth2/authorize?client_id=1442793864216969268&scope=bot%20applications.commands&permissions=...
```

**重要**: URLに`scope=bot%20applications.commands`が含まれているか確認してください。

#### 結果

- ✅ **`applications.commands`が含まれている場合**: ステップ4へ
- ❌ **`applications.commands`が含まれていない場合**: ステップ6へ（Botを再追加）

---

### ステップ4: 正しいサーバーIDか確認

ログには以下のように表示されています：

```
📡 テストギルド (1432610184076984382) に同期します...
```

1. **Discordで「Winglish」サーバーを開く**
2. **サーバー名を右クリック** → **「サーバー設定」**
3. **左サイドバーから「ウィジェット」**を選択
4. **「サーバーID」をコピー**

#### 確認

コピーしたサーバーIDが `1432610184076984382` と一致しているか確認してください。

#### 結果

- ✅ **一致している場合**: ステップ5へ
- ❌ **一致していない場合**: Railwayの環境変数`TEST_GUILD_ID`を正しいサーバーIDに更新してください

---

### ステップ5: Botを再追加（強制的に）

権限の問題を解決するため、Botを一度削除してから再追加します。

#### 5-1. Botをサーバーから削除

1. **Discordで「Winglish」サーバーを開く**
2. **サーバー名を右クリック** → **「サーバー設定」**
3. **左サイドバーから「メンバー」を選択**
4. **「Winglish Bot」を探してクリック**
5. **「サーバーから削除」をクリック**
6. **確認ダイアログで「削除」をクリック**

#### 5-2. OAuth2 URLを生成（`applications.commands`スコープ付き）

1. **Discord Developer Portal**で、**「OAuth2」** → **「URL Generator」**を開く
2. **「SCOPES」**セクションで以下をチェック：
   - ✅ **`bot`**
   - ✅ **`applications.commands`** ← **必須！**
3. **「BOT PERMISSIONS」**セクションで必要な権限を選択
4. **生成されたURLをコピー**
5. **URLをブラウザで開く**
6. **「サーバーを選択」**で「Winglish」を選択
7. **「続行」** → **「認証」**をクリック

#### 5-3. Botを再デプロイ

1. **Railway**ダッシュボードで**「Winglish-bot」**サービスを選択
2. **「Deployments」**タブを選択
3. **最新のデプロイの「...」メニュー**をクリック
4. **「Redeploy」**をクリック

または、Railway CLIを使用：

```bash
cd /tmp/Winglish-bot
railway redeploy --yes
```

---

### ステップ6: 最大1時間待つ

Discordのグローバル同期は最大1時間かかることがあります。ただし、`TEST_GUILD_ID`が設定されている場合、テストギルドでは**すぐに反映**されるはずです。

---

## ⚠️ よくある問題

### 問題1: URLに`applications.commands`が含まれているのに、コマンドが表示されない

**原因**: Botを追加した後にスコープを変更した場合、既存のBotには反映されません。

**解決方法**: Botを一度削除してから、新しいURLで再追加してください。

---

### 問題2: ログには成功しているが、Discordではコマンドが表示されない

**原因**: Discordのキャッシュの問題、または反映に時間がかかっている。

**解決方法**:
1. Discordアプリを再起動
2. 最大1時間待つ（グローバル同期の場合）
3. Botを再デプロイ

---

### 問題3: `TEST_GUILD_ID`が設定されているのに、コマンドが表示されない

**原因**: `TEST_GUILD_ID`が間違っている、またはBotがそのサーバーに追加されていない。

**解決方法**:
1. DiscordでサーバーIDを確認
2. Railwayの環境変数`TEST_GUILD_ID`を更新
3. Botを再デプロイ

---

## 📋 チェックリスト

診断を完了したら、以下を確認してください：

- [ ] Botがサーバーのメンバーとして表示されている
- [ ] Botに「スラッシュコマンド」の権限がある
- [ ] OAuth2 URLに`applications.commands`スコープが含まれている
- [ ] `TEST_GUILD_ID`が正しいサーバーIDと一致している
- [ ] Botを一度削除してから、新しいURL（`applications.commands`スコープ付き）で再追加した
- [ ] Botを再デプロイした
- [ ] Discordアプリを再起動した

---

## 🎯 次のステップ

すべての手順を完了したら：

1. **Discordでコマンドを確認**
   - `/`を入力して、コマンドが表示されるか確認
   - `/sys_notebooks`コマンドが表示されるか確認

2. **ログを確認**
   - Railwayのログで、`📊 同期後にDiscord APIから取得したコマンド数: 9`以上が表示されるか確認

3. **コマンドをテスト**
   - `/start`コマンドを実行して、メニューが表示されるか確認
   - `/sys_notebooks`コマンドを実行して、システム推奨単語帳が表示されるか確認

